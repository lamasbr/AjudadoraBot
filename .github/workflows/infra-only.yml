name: Terraform Infra (Plan/Apply)

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Choose Terraform action'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      state_rg:
        description: 'State Resource Group (optional)'
        required: false
        type: string
      state_sa:
        description: 'State Storage Account (optional)'
        required: false
        type: string
      state_container:
        description: 'State Container (optional, default tfstate)'
        required: false
        type: string
      auto_approve:
        description: 'Auto approve apply'
        required: false
        default: false
        type: boolean
  push:
    branches: [ 'infra/**' ]

permissions:
  contents: read

concurrency:
  group: terraform-${{ github.ref }}
  cancel-in-progress: true

jobs:
  terraform:
    name: Terraform ${{ inputs.action || 'plan' }} (${{ inputs.environment || 'production' }})
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'production' }}
    timeout-minutes: 45

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.12.2

    - name: Azure Login (Service Principal)
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Bootstrap Remote Backend (ensure state storage exists)
      working-directory: ./terraform/bootstrap
      env:
        ARM_CLIENT_ID: ${{ fromJSON(secrets.AZURE_CREDENTIALS).clientId }}
        ARM_CLIENT_SECRET: ${{ fromJSON(secrets.AZURE_CREDENTIALS).clientSecret }}
        ARM_TENANT_ID: ${{ fromJSON(secrets.AZURE_CREDENTIALS).tenantId }}
        ARM_SUBSCRIPTION_ID: ${{ fromJSON(secrets.AZURE_CREDENTIALS).subscriptionId }}
      run: |
        terraform init -upgrade
        terraform apply -auto-approve -var "environment=${{ inputs.environment || 'production' }}"

    - name: Get Backend Values
      id: backend
      working-directory: ./terraform/bootstrap
      run: |
        echo "rg=$(terraform output -raw state_resource_group)" >> $GITHUB_OUTPUT
        echo "sa=$(terraform output -raw state_storage_account)" >> $GITHUB_OUTPUT
        echo "ct=$(terraform output -raw state_container)" >> $GITHUB_OUTPUT

    - name: Terraform Init (remote backend)
      working-directory: ./terraform
      env:
        ARM_CLIENT_ID: ${{ fromJSON(secrets.AZURE_CREDENTIALS).clientId }}
        ARM_CLIENT_SECRET: ${{ fromJSON(secrets.AZURE_CREDENTIALS).clientSecret }}
        ARM_TENANT_ID: ${{ fromJSON(secrets.AZURE_CREDENTIALS).tenantId }}
        ARM_SUBSCRIPTION_ID: ${{ fromJSON(secrets.AZURE_CREDENTIALS).subscriptionId }}
      run: |
        set -e
        RG="${{ inputs.state_rg }}"; SA="${{ inputs.state_sa }}"; CT="${{ inputs.state_container }}"
        [ -z "$RG" ] && RG="${{ steps.backend.outputs.rg }}"
        [ -z "$SA" ] && SA="${{ steps.backend.outputs.sa }}"
        [ -z "$CT" ] && CT="${{ steps.backend.outputs.ct }}"
        [ -z "$CT" ] && CT="tfstate"
        KEY="ajudadorabot-${{ inputs.environment || 'production' }}.tfstate"
        CONFIGS=(
          -backend-config="resource_group_name=$RG"
          -backend-config="storage_account_name=$SA"
          -backend-config="container_name=$CT"
          -backend-config="key=$KEY"
        )
        echo "Initializing backend with Azure AD auth..."
        if terraform init -upgrade "${CONFIGS[@]}" -backend-config="use_azuread_auth=true"; then
          echo "Backend initialized with Azure AD auth."
        else
          echo "Azure AD auth failed. Falling back to access key auth."
          ACCESS_KEY=$(az storage account keys list --resource-group "$RG" --account-name "$SA" --query "[0].value" -o tsv)
          if [ -z "$ACCESS_KEY" ]; then
            echo "Failed to retrieve storage account access key" >&2
            exit 1
          fi
          export ARM_ACCESS_KEY="$ACCESS_KEY"
          terraform init -upgrade -reconfigure "${CONFIGS[@]}"
        fi

    - name: Terraform Validate
      working-directory: ./terraform
      run: terraform validate

    - name: Terraform Plan
      if: ${{ inputs.action == 'plan' || inputs.action == '' }}
      working-directory: ./terraform
      env:
        ARM_CLIENT_ID: ${{ fromJSON(secrets.AZURE_CREDENTIALS).clientId }}
        ARM_CLIENT_SECRET: ${{ fromJSON(secrets.AZURE_CREDENTIALS).clientSecret }}
        ARM_TENANT_ID: ${{ fromJSON(secrets.AZURE_CREDENTIALS).tenantId }}
        ARM_SUBSCRIPTION_ID: ${{ fromJSON(secrets.AZURE_CREDENTIALS).subscriptionId }}
        TF_VAR_environment: ${{ inputs.environment || 'production' }}
        TF_VAR_telegram_bot_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TF_VAR_datadog_api_key: ${{ secrets.DATADOG_API_KEY }}
        TF_VAR_ghcr_username: ${{ github.actor }}
        TF_VAR_ghcr_token: ${{ secrets.GITHUB_TOKEN }}
      run: terraform plan -out=tfplan

    - name: Terraform Apply
      if: ${{ inputs.action == 'apply' }}
      working-directory: ./terraform
      env:
        ARM_CLIENT_ID: ${{ fromJSON(secrets.AZURE_CREDENTIALS).clientId }}
        ARM_CLIENT_SECRET: ${{ fromJSON(secrets.AZURE_CREDENTIALS).clientSecret }}
        ARM_TENANT_ID: ${{ fromJSON(secrets.AZURE_CREDENTIALS).tenantId }}
        ARM_SUBSCRIPTION_ID: ${{ fromJSON(secrets.AZURE_CREDENTIALS).subscriptionId }}
        TF_VAR_environment: ${{ inputs.environment || 'production' }}
        TF_VAR_telegram_bot_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TF_VAR_datadog_api_key: ${{ secrets.DATADOG_API_KEY }}
        TF_VAR_ghcr_username: ${{ github.actor }}
        TF_VAR_ghcr_token: ${{ secrets.GITHUB_TOKEN }}
      run: |
        if [ "${{ inputs.auto_approve }}" = "true" ]; then
          terraform apply -auto-approve tfplan || terraform apply -auto-approve
        else
          terraform apply tfplan || terraform apply
        fi

    - name: Show Outputs
      if: always()
      working-directory: ./terraform
      run: |
        terraform output || true
